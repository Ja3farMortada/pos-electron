import{a as b}from"./chunk-QJMHFOYW.js";import{b as p}from"./chunk-G5UOHYUM.js";import{b as g}from"./chunk-4A2WLUYH.js";import{C as c,Vb as m,Wb as f,d as h,da as o,pb as d,r as a,y as u,yb as l}from"./chunk-DSVZHE42.js";var A=(()=>{class n{constructor(){this.http=c(d),this.router=c(l),this.notificationService=c(m),this.socket=c(b),this.userService=c(g),this.currencyService=c(p),this.defaultCurrency=this.currencyService.defaultCurrency,this.customers=o([]),this.selectedCustomer=o(null),this.customersTotalDebts$=o({id:0,balance:0}),this.customerDialogVisible=o(!1),this.newOrder$=new h(null),this.customerBalance$=new h([]),this.submitCustomerLoading=o(!1),this.signal_tableLoading=o(!1),this.signal_balanceLoading=o(!1),this.api=c(f),this.host=this.api.host,this.debts=o([]),this.debtsLoading=o(!1),this.glowingRowIndex=o(null),this.socketId=this.userService.socketId,this.getCustomers(),this.initializeSockets()}getDebts(e){this.debtsLoading.set(!0),this.http.get(`${this.host()}/customers/debts/${e}`).subscribe({next:t=>{this.debts.set(t),this.debtsLoading.set(!1)},error:t=>{this.notificationService.handleError(t.error,"home"),this.debtsLoading.set(!1)}})}getCustomers(){this.signal_tableLoading.set(!0),this.http.get(`${this.host()}/customers`).pipe(a(()=>{this.signal_tableLoading.set(!1)})).subscribe({next:e=>{this.customers.set(e)},error:e=>{this.notificationService.handleError(e.error,"home")}})}deleteCustomer(e){this.http.delete(`${this.host()}/customers/${e.account_id}`).subscribe({next:t=>{this.customers.update(i=>{let r=this.customers().findIndex(s=>s.account_id===e.account_id);return i.splice(r,1),[...i]}),this.selectedCustomer.set(null),this.notificationService.showSuccess(t.message,"home")},error:t=>{this.notificationService.handleError(t.error,"home")}})}getCustomerBalance(e,t,i,r){this.submitCustomerLoading.set(!0),this.http.get(`${this.host()}/customers/transactions/${e}&${t}&${i}&${r}`).subscribe({next:s=>{this.customerBalance$.next(s)},error:s=>{this.notificationService.handleError(s.error,"home"),this.submitCustomerLoading.set(!1)},complete:()=>{this.submitCustomerLoading.set(!1)}})}getAccountTotalBalance(e,t){this.signal_balanceLoading.set(!0),this.http.get(`${this.host()}/customers/${e}/balance/${t}`).subscribe({next:i=>{this.customersTotalDebts$.set(i)},error:i=>{this.notificationService.handleError(i.error,"home"),this.signal_balanceLoading.set(!1)},complete:()=>{this.signal_balanceLoading.set(!1)}})}highlightRow(e){this.glowingRowIndex.set(e),setTimeout(()=>{this.glowingRowIndex.set(null)},2e3)}initializeSockets(){this.socket.on("customerCreated",e=>{let t=e[0];e[1].user_id!=this.socketId()&&(this.customers.set([...this.customers(),t]),this.notificationService.showSocketMessage("New customer created!","home"),this.highlightRow(this.customers().length-1))}),this.socket.on("customerUpdated",e=>{let t=e[0];if(e[1].user_id!=this.socketId()){let r=this.customers().findIndex(s=>s.account_id===t.account_id);this.customers.update(s=>[...s.slice(0,r),t,...s.slice(r+1)]),t.account_id==this.selectedCustomer()?.account_id&&this.selectedCustomer.set(t),this.notificationService.showSocketMessage("A customer has been updated!","home"),this.highlightRow(r)}}),this.socket.on("customerDeleted",e=>{let t=e[0];e[1].user_id!=this.socketId()&&(this.customers.update(r=>{let s=this.customers().findIndex(S=>S.account_id===t.account_id);return r.splice(s,1),[...r]}),t.account_id==this.selectedCustomer()?.account_id&&this.selectedCustomer.set(null),this.notificationService.showSocketMessage("A customer has been deleted!","home"))}),this.socket.on("addedCustomerPayment",e=>{e.user_id!=this.socketId()&&(this.getDebts(this.currencyService.defaultCurrency()),this.notificationService.showSocketMessage("A new payment has been added!","home"))}),this.socket.on("updatedCustomerPayment",e=>{e.user_id!=this.socketId()&&(this.getDebts(this.currencyService.defaultCurrency()),this.notificationService.showSocketMessage("A payment has been updated!","home"))}),this.socket.on("deletedCustomerPayment",e=>{e.user_id!=this.socketId()&&(this.getDebts(this.currencyService.defaultCurrency()),this.notificationService.showSocketMessage("A payment has been deleted!","home"))})}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=u({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{A as a};
