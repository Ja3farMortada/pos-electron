import{a as Ue}from"./chunk-PEPXHHLM.js";import{a as Qe,b as ze}from"./chunk-VL5A4WUO.js";import{a as He,b as Ke}from"./chunk-I32A4TGG.js";import"./chunk-4ONBVWLA.js";import"./chunk-UIPYUTXU.js";import{c as Ye}from"./chunk-OX3TH2OU.js";import"./chunk-FPREGWMZ.js";import"./chunk-ARZ4TFMZ.js";import{a as Je,b as Ge}from"./chunk-XWYC6WG4.js";import{a as Ee}from"./chunk-RIKI2T7Q.js";import{a as We,b as Ae,c as Ze}from"./chunk-OKPWRQQW.js";import{a as X}from"./chunk-IQTEOPEP.js";import{c as xe}from"./chunk-6CXWHLUJ.js";import{a as U}from"./chunk-SBLJNY6Q.js";import"./chunk-KICUZIBO.js";import{a as Oe}from"./chunk-HV2OQ7WI.js";import"./chunk-OY4T6UDA.js";import"./chunk-7ZNGIE4A.js";import{a as je}from"./chunk-FO7TG3S7.js";import{b as G}from"./chunk-42BTCZ3Y.js";import{a as Fe,b as Ne}from"./chunk-7QYRFDGN.js";import{a as _e,b as qe}from"./chunk-PIXVAYN4.js";import{a as Le}from"./chunk-7KO4RDVD.js";import{a as Y}from"./chunk-UJ5JDQTE.js";import"./chunk-ZPRVI3IV.js";import"./chunk-UVEVFGTS.js";import"./chunk-P4HR6EQA.js";import{d as Z,e as J,f as De}from"./chunk-NEQPNYWW.js";import{a as Se,b as F}from"./chunk-AFTSMEUE.js";import{F as Re,f as we,g as Te,i as Ie,j as Ve,l as Pe,m as Me,t as Be,u as ke}from"./chunk-LBGQA5HW.js";import"./chunk-4A2WLUYH.js";import{b as be,c as z}from"./chunk-VVKQAEX7.js";import{a as K,b as Q}from"./chunk-FW7KDDDM.js";import{Ba as B,C as g,Ca as k,D as M,Da as R,Ea as S,Fa as f,Ga as y,Ha as b,Ia as pe,J as se,Ja as w,Jb as de,K as d,Ka as T,L as m,La as I,Na as E,Oa as D,S as te,Sb as me,Vb as j,Wb as H,X as ce,Xa as c,Y as r,Ya as p,ac as he,da as q,fc as fe,ga as x,ia as h,ib as O,la as ie,lc as ge,mb as W,nb as A,oa as a,pa as l,pb as ue,qa as P,r as ae,ua as V,va as v,wa as u,wc as ve,xc as Ce,y as le,zc as ye}from"./chunk-DSVZHE42.js";import"./chunk-GAL4ENT6.js";var $=(()=>{class o{updateZeroItemsState(){this.localStorageService.setShowZeroItems(this.showZeroItems())}constructor(){this.http=g(ue),this.apiService=g(H),this.notificationService=g(j),this.stockService=g(Z),this.cashBalanceService=g(U),this.historyService=g(X),this.localStorageService=g(Se),this.decimalService=g(J),this.currencySetting=g(F),this.defaultCurrency=this.currencySetting.defaultCurrency,this.invoices=[],this.activeInvoiceId=null,this.nextId=1,this.fieldsetCollapsed=q(!1),this.showZeroItems=q(this.localStorageService.getShowZeroItems()),this.customerDialogVisible=q(!1),this.inventories=this.stockService.inventories,this.loadingInventories=this.stockService.loadingInventories,this.defaultInventory=this.stockService.defaultInventory,this.openInvoice()}openInvoice(){let e={id:this.nextId++,total_cost:0,total_avg_cost:0,total_amount:0,total_lbp:0,journal_notes:null,total_qty:0,items:[],modify_cash:!0,currency:this.defaultCurrency(),inventory_id:this.defaultInventory()};this.invoices.push(e),this.setActiveInvoice(e.id)}closeInvoice(e){if(this.invoices.length===1){this.clearInvoice(this.invoices[0]);return}if(this.invoices=this.invoices.filter(i=>i.id!==e),this.activeInvoiceId===e){let i=this.invoices[0];this.setActiveInvoice(i.id)}}clearInvoice(e){e.customer_id=void 0,e.total_amount=0,e.total_cost=0,e.total_avg_cost=0,e.total_lbp=0,e.total_qty=0,e.items=[]}setActiveInvoice(e){this.activeInvoiceId=e}get activeInvoice(){return this.invoices.find(e=>e.id===this.activeInvoiceId)}addItemToActiveInvoice(e){let i=this.activeInvoice;i&&(i.items.push(e),this.recalculateTotals(i))}recalculateTotals(e){let i=e.items.reduce((t,n)=>{let s=n.quantity||0,_=n.unit_price||0,N=n.unit_price_lbp||0,ee=n.unit_cost||0,L=n.avg_cost||0;return t.total_amount=this.decimalService.add(t.total_amount,this.decimalService.multiply(_,s)),t.total_lbp=this.decimalService.add(t.total_lbp,this.decimalService.multiply(N,s)),t.total_cost=this.decimalService.add(t.total_cost,this.decimalService.multiply(ee,s)),t.total_avg_cost=this.decimalService.add(t.total_avg_cost,this.decimalService.multiply(L,s)),t.total_qty=this.decimalService.add(t.total_qty,s),t},{total_amount:0,total_lbp:0,total_cost:0,total_avg_cost:0,total_qty:0});e.total_amount=i.total_amount,e.total_lbp=i.total_lbp,e.total_cost=i.total_cost,e.total_avg_cost=i.total_avg_cost,e.total_qty=i.total_qty}static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275prov=le({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();var nt=["productAutoComplete"],ot=["barcodeInput"],rt=["confirmDialog"],Xe=()=>({width:"50vw"}),$e=()=>({"1199px":"65vw","575px":"90vw"}),at=()=>["name","phone"];function lt(o,C){if(o&1&&(a(0,"div"),f(1),l(),a(2,"small"),f(3),l()),o&2){let e=C.$implicit;r(),y(e.name),r(2),y(e.phone)}}function st(o,C){if(o&1&&(a(0,"div"),f(1),l()),o&2){let e=u(3);r(),b(" ",e.selectedCustomer.name," ")}}function ct(o,C){if(o&1&&(a(0,"small"),f(1),l()),o&2){let e=u(3);r(),y(e.selectedCustomer.phone)}}function pt(o,C){if(o&1&&x(0,st,2,1,"div",35)(1,ct,2,1,"small",35),o&2){let e=u(2);h("ngIf",e.selectedCustomer),r(),h("ngIf",e.selectedCustomer)}}function ut(o,C){if(o&1&&(a(0,"div",36)(1,"table")(2,"thead")(3,"tr",37)(4,"th"),f(5),c(6,"translate"),l(),a(7,"th"),f(8),c(9,"translate"),l(),a(10,"th"),f(11),c(12,"translate"),l()()(),a(13,"tbody")(14,"tr",38)(15,"th")(16,"text-with-loading",39)(17,"span"),f(18),c(19,"currency"),c(20,"lira"),l()()(),a(21,"th"),f(22),c(23,"currency"),c(24,"lira"),l(),a(25,"th")(26,"text-with-loading",40)(27,"span"),f(28),c(29,"currency"),c(30,"lira"),l()()()()()()()),o&2){let e=u(2);r(5),y(p(6,10,"Old Balance")),r(3),b(" ",p(9,12,"Current Invoice")," "),r(3),y(p(12,14,"New Balance")),r(5),h("isLoading",e.customer_balance_loading())("loadingBar",!0),r(2),y(e.defaultCurrency()==="dollar"?p(19,16,e.customer_balance().balance):p(20,18,e.customer_balance().balance)),r(4),b(" ",e.defaultCurrency()==="dollar"?p(23,20,e.invoice.total_amount):p(24,22,e.invoice.total_amount)," "),r(4),h("isLoading",e.customer_balance_loading())("loadingBar",!0),r(2),y(e.defaultCurrency()==="dollar"?p(29,24,e.calculateNewBalance(e.customer_balance().balance,e.invoice.total_amount,0)):p(30,26,e.calculateNewBalance(e.customer_balance().balance,e.invoice.total_amount,0)))}}function dt(o,C){if(o&1){let e=V();a(0,"div",28)(1,"div",13)(2,"div",29)(3,"label",30),f(4),c(5,"translate"),l(),a(6,"p-dropdown",31),c(7,"translate"),c(8,"translate"),v("onShow",function(){d(e);let t=u();return m(t.dropDownVisible=!0)})("onHide",function(){d(e);let t=u();return m(t.dropDownVisible=!1)})("onChange",function(t){d(e);let n=u();return m(n.onCustomerChange(t.value))}),x(9,lt,4,2,"ng-template",32)(10,pt,2,2,"ng-template",33),l()()(),x(11,ut,31,28,"div",34),l()}if(o&2){let e=u();r(4),y(p(5,11,"Customer")),r(2),h("loading",e.loadingCustomers())("placeholder",p(7,13,"Select Customer"))("emptyMessage",p(8,15,"No results found"))("filter",!0)("showClear",!0)("autoOptionFocus",!1)("filterFields",D(17,at))("options",e.customers())("ngModel",e.selectedCustomer),r(5),h("ngIf",e.selectedCustomer)}}function mt(o,C){if(o&1&&(a(0,"div"),f(1),l(),a(2,"small"),f(3),c(4,"currency"),l()),o&2){let e=C.$implicit;r(),b(" ",e.product_name," "),r(2),y(p(4,2,e.unit_price_usd))}}function _t(o,C){if(o&1){let e=V();a(0,"div",28)(1,"div",41)(2,"p-autoComplete",42,3),c(5,"translate"),c(6,"translate"),v("completeMethod",function(t){d(e);let n=u();return m(n.filterProducts(t))}),I("ngModelChange",function(t){d(e);let n=u();return T(n.productSearchText,t)||(n.productSearchText=t),m(t)}),v("onKeyUp",function(t){d(e);let n=u();return m(n.handleProductInputKeydown(t))}),x(7,mt,5,4,"ng-template",32),l(),a(8,"p-button",43),c(9,"translate"),v("onClick",function(){d(e);let t=u();return m(t.productsDialogVisible=!0)}),l()(),a(10,"div",13)(11,"p-dropdown",44),c(12,"translate"),c(13,"translate"),I("ngModelChange",function(t){d(e);let n=u();return T(n.defaultInventory,t)||(n.defaultInventory=t),m(t)}),v("ngModelChange",function(){d(e);let t=u();return m(t.getProducts())}),l()(),a(14,"div",45)(15,"label",46),f(16),c(17,"translate"),l(),a(18,"p-inputSwitch",47),I("ngModelChange",function(t){d(e);let n=u();return T(n.invoice.modify_cash,t)||(n.invoice.modify_cash=t),m(t)}),l()()()}if(o&2){let e=u();r(2),h("suggestions",e.filteredProducts)("dropdown",!1)("minLength",1)("showClear",!0),w("ngModel",e.productSearchText),h("placeholder",p(5,18,"scan or search"))("emptyMessage",p(6,20,"No results found"))("delay",0),r(6),h("label",p(9,22,"Select")),r(3),h("autoOptionFocus",!1),w("ngModel",e.defaultInventory),h("options",e.inventories())("placeholder",p(12,24,"Select Inventory"))("emptyMessage",p(13,26,"No results found"))("filter",!0),r(5),y(p(17,28,"Modify Cash")),r(2),w("ngModel",e.invoice.modify_cash),h("disabled",e.invoice.customer_id!==null)}}function ht(o,C){o&1&&(a(0,"tr")(1,"th",48),f(2),c(3,"translate"),l(),a(4,"th",49),f(5),c(6,"translate"),l(),a(7,"th",50),f(8),c(9,"translate"),l(),a(10,"th",48),f(11),c(12,"translate"),l(),a(13,"th",51),f(14),c(15,"translate"),l(),a(16,"th",52),c(17,"translate"),f(18),c(19,"translate"),l(),a(20,"th",48),f(21),c(22,"translate"),l(),a(23,"th",51),f(24),c(25,"translate"),l()()),o&2&&(r(2),y(p(3,9,"SKU")),r(3),y(p(6,11,"Barcode")),r(3),b(" ",p(9,13,"Description")," "),r(3),y(p(12,15,"Unit")),r(3),y(p(15,17,"Qty")),r(2),h("pTooltip",p(17,19,"Remaining quantity")),r(2),b(" ",p(19,21,"New Qty")," "),r(3),y(p(22,23,"Total")),r(3),y(p(25,25,"Del")))}function ft(o,C){if(o&1){let e=V();a(0,"tr")(1,"td"),f(2),l(),a(3,"td"),f(4),l(),a(5,"td",53),f(6),l(),a(7,"td",54),v("click",function(t){let n=d(e).rowIndex,s=u(),_=S(20);return m(s.openEdit(_,t,n,"price"))}),f(8),c(9,"currency"),c(10,"lira"),l(),a(11,"td",54),v("click",function(t){let n=d(e).rowIndex,s=u(),_=S(20);return m(s.openEdit(_,t,n,"quantity"))}),f(12),l(),a(13,"td"),f(14),l(),a(15,"td",54),v("click",function(t){let n=d(e).rowIndex,s=u(),_=S(20);return m(s.openEdit(_,t,n,"total"))}),f(16),c(17,"currency"),c(18,"lira"),l(),a(19,"td",55),v("click",function(){let t=d(e).rowIndex,n=u();return m(n.removeRow(t))}),P(20,"i",56),l()()}if(o&2){let e=C.$implicit,i=u();r(2),y(e.sku||"---"),r(2),y(e.barcode||"---"),r(),h("pTooltip",i.userPermissions().show_cost?e.unit_cost:null),r(),b(" ",e.product_name," "),r(2),b(" ",i.defaultCurrency()==="dollar"?p(9,8,e.unit_price):p(10,10,e.unit_price)," "),r(4),b(" ",e.quantity," "),r(2),b(" ",e.stock_management?(+e.stock+ +e.quantity).toFixed(2):"--"," "),r(2),b(" ",i.defaultCurrency()==="dollar"?p(17,12,e.unit_price*e.quantity):p(18,14,e.unit_price*e.quantity)," ")}}function gt(o,C){if(o&1&&(a(0,"h4",58),f(1),c(2,"translate"),l()),o&2){let e=u(2);r(),pe(" ",p(2,2,"Total units:")," ",e.invoice.total_qty," ")}}function vt(o,C){if(o&1&&x(0,gt,3,4,"h4",57),o&2){let e=u();h("ngIf",e.invoice.total_qty)}}function Ct(o,C){o&1&&(a(0,"tr",59)(1,"td",60),f(2),c(3,"translate"),l()()),o&2&&(r(2),b(" ",p(3,1,"No data yet!")," "))}function yt(o,C){if(o&1){let e=V();a(0,"p-inputNumber",61),I("ngModelChange",function(t){d(e);let n=u();return T(n.editingValue,t)||(n.editingValue=t),m(t)}),v("onFocus",function(t){d(e);let n=u();return m(n.select(t.target))})("onBlur",function(){d(e);let t=u(),n=S(20);return m(t.applyEdit(n))})("onKeyDown",function(t){d(e);let n=u(),s=S(20);return m(n.submitEdit(t,s))}),l()}if(o&2){let e=u();w("ngModel",e.editingValue),h("maxFractionDigits",2)("min",0)("autofocus",!0)}}function bt(o,C){if(o&1){let e=V();a(0,"p-inputNumber",61),I("ngModelChange",function(t){d(e);let n=u();return T(n.editingValue,t)||(n.editingValue=t),m(t)}),v("onFocus",function(t){d(e);let n=u();return m(n.select(t.target))})("onBlur",function(){d(e);let t=u(),n=S(20);return m(t.applyEdit(n))})("onKeyDown",function(t){d(e);let n=u(),s=S(20);return m(n.submitEdit(t,s))}),l()}if(o&2){let e=u();w("ngModel",e.editingValue),h("maxFractionDigits",2)("min",0)("autofocus",!0)}}function xt(o,C){if(o&1){let e=V();a(0,"p-inputNumber",62),I("ngModelChange",function(t){d(e);let n=u();return T(n.editingValue,t)||(n.editingValue=t),m(t)}),v("onFocus",function(t){d(e);let n=u();return m(n.select(t.target))})("onBlur",function(){d(e);let t=u(),n=S(20);return m(t.applyEdit(n))})("onKeyDown",function(t){d(e);let n=u(),s=S(20);return m(n.submitEdit(t,s))}),l()}if(o&2){let e=u();w("ngModel",e.editingValue),h("maxFractionDigits",2)("minFractionDigits",0)("autofocus",!0)}}function St(o,C){if(o&1){let e=V();a(0,"p-button",63),c(1,"translate"),v("onClick",function(){d(e);let t=u();return m(t.confirmCheckoutAndPrint())}),l(),a(2,"p-button",64),c(3,"translate"),v("onClick",function(){d(e);let t=u();return m(t.rejectCheckout())}),l(),a(4,"p-button",65),c(5,"translate"),v("onClick",function(){d(e);let t=u();return m(t.confirmCheckout())}),l()}o&2&&(h("label",p(1,3,"Yes & Print")),r(2),h("label",p(3,5,"No")),r(2),h("label",p(5,7,"Yes")))}var oe=(()=>{class o{constructor(){this.returnService=g($),this.customersService=g(Ee),this.dollarPipe=g(De),this.stockService=g(Z),this.translate=g(be),this.decimalService=g(J),this.authService=g(_e),this.notificationService=g(j),this.printService=g(qe),this.printerSettingsService=g(Le),this.confirmationService=g(de),this.apiService=g(H),this.historyService=g(X),this.cashBalanceService=g(U),this.customersFeaturesService=g(Oe),this.currencyService=g(F),this.defaultCurrency=this.currencyService.defaultCurrency,this.productDialogVisible=!1,this.userPermissions=this.authService.userPermissions,this.productsDialogVisible=!1,this.stockTableLoading=this.stockService.tableLoading,this.customersFeaturesEnabled=this.customersFeaturesService.customersFeaturesEnabled,this.products=this.stockService.products,this.filteredProducts=[],this.productSearchText="",this.view_currency="dollar",this.selected_price_type="unit_price_usd",this.stateOptions=[{label:this.translate.instant("Retail"),value:"unit_price_usd"},{label:this.translate.instant("Wholesale"),value:"wholesale_price_usd"}],this.exchangeRate=this.stockService.exchangeRate,this.customers=this.customersService.customers,this.loadingCustomers=this.customersService.signal_tableLoading,this.dropDownVisible=!1,this.customerDialogVisible=!1,this.customer_balance_loading=this.customersService.signal_balanceLoading,this.customer_balance=this.customersService.customersTotalDebts$,this.operationTypes=[{label:this.translate.instant("Normal"),value:"normal"},{label:this.translate.instant("Debt"),value:"debt"}],this.editModeEnabled=!1,this.editingRowIndex=null,this.editingField="",this.printerSettings=this.printerSettingsService.printerSettings,this.thermalPrinterEnabled=this.printerSettingsService.thermalPrinterEnabled,this.confirmShowed=!1,this.checkoutLoading=!1,this.printDialogVisible=!1,this.inventories=this.returnService.inventories,this.loadingInventories=this.returnService.loadingInventories,this.defaultInventory=this.returnService.defaultInventory}focusAcceptButton(){let e=this.confirmDialog.nativeElement.querySelector(".p-confirm-dialog-accept");e&&e.focus()}focusRejectButton(){let e=this.confirmDialog.nativeElement.querySelector(".p-confirm-dialog-reject");e&&e.focus()}focusBarcodeInput(){this.barcodeInput.nativeElement.querySelector("input").focus()}blurBarcodeInput(){this.barcodeInput.nativeElement.querySelector("input").blur()}onKeyDown(e){if(this.editModeEnabled||this.productDialogVisible||this.printDialogVisible)return;let t=navigator.userAgent.toUpperCase().includes("MAC")?e.metaKey:e.ctrlKey,n=e.key.toLowerCase();if(!(n==="meta"||n==="control"||n==="shift"||n==="alt")&&!(t&&["c","v","p","x","a","s","z","y"].includes(n))){if(this.confirmShowed){e.code=="ArrowRight"?this.focusAcceptButton():e.code=="ArrowLeft"&&this.focusRejectButton();return}else{if(this.dropDownVisible||this.productsDialogVisible||this.customerDialogVisible||this.confirmShowed)return;e.code=="Enter"&&!this.productSearchText&&this.invoice.items.length>0?this.checkout():this.focusBarcodeInput()}e.key==="+"?this.productSearchText||(this.addQtyToLastItem(),setTimeout(()=>{this.productSearchText="",this.blurBarcodeInput(),this.productAutoComplete.hide()})):e.key==="-"?this.productSearchText||(this.removeQtyFromLastItem(),setTimeout(()=>{this.productSearchText="",this.blurBarcodeInput(),this.productAutoComplete.hide()})):this.focusBarcodeInput()}}recalculateTotals(){this.returnService.recalculateTotals(this.invoice)}filterProducts(e){let i=e.query.toLowerCase();this.filteredProducts=this.products().filter(t=>t.product_name.toLowerCase().includes(i)||t.sku?.toLowerCase().includes(i)||t.barcode?.toLowerCase().includes(i))}handleProductInputKeydown(e){e.key==="Enter"&&(this.productSearchText&&(this.processProductSearch(this.productSearchText),e.preventDefault()),this.productSearchText="",setTimeout(()=>{this.productAutoComplete.hide()},50))}processProductSearch(e){if(typeof e=="string"){if(!e?.trim())return;let i=1,t=e.trim(),n=["*","+"];for(let _ of n){let N=t.indexOf(_);if(N>0){let ee=t.substring(0,N),L=t.substring(N+1),re=parseInt(ee);!isNaN(re)&&L&&(i=re,t=L);break}}let s=this.products().find(_=>_.barcode?.toLowerCase()===t.toLowerCase()||_.sku?.toLowerCase()===t.toLowerCase()||_.product_name?.toLowerCase()===t.toLowerCase());s?(this.addProductToInvoice(s,i),this.resetProductSearch()):this.notificationService.showError("Item not found!","home")}else typeof e=="object"&&e?.product_id&&(this.addProductToInvoice(e,1),this.resetProductSearch());this.productAutoComplete.hide()}addProductToInvoice(e,i=1){let t=this.invoice.items.find(n=>n.product_id===e.product_id);if(t)t.quantity+=i,t.total_price=t.unit_price*t.quantity;else{let n=e.unit_price_usd,s=e.unit_cost_usd,_=e.avg_cost_usd;this.defaultCurrency()==="dollar"?e.currency=="lira"&&(n=n/this.exchangeRate().rate_value,s=s/this.exchangeRate().rate_value,_=_/this.exchangeRate().rate_value):e.currency=="dollar"&&(n=this.dollarPipe.calculate(n),s=this.dollarPipe.calculate(s),_=this.dollarPipe.calculate(_)),this.invoice.items.push({product_id:e.product_id,barcode:e.barcode,product_name:e.product_name,unit_cost:s,avg_cost:_,original_price:n,unit_price:n,unit_price_lbp:this.dollarPipe.calculate(n),quantity:i,stock_management:e.stock_management,stock:e.quantity,low_stock_threshold:e.low_stock_threshold,currency:e.currency})}this.recalculateTotals()}onProductSelection(e){this.addProductToInvoice(e)}resetProductSearch(){this.productSearchText="",this.filteredProducts=[],this.productAutoComplete.hide()}assignSelectedProducts(e){this.productsDialogVisible=!1,e.forEach(i=>{this.addProductToInvoice(i,1)})}getPriceWarning(e){if(this.userPermissions().show_cost){if(!e.unit_price)return!1;let i=e.unit_cost||0,t=e.unit_price;return typeof i=="string"&&(i=parseFloat(i)),typeof t=="string"&&(t=parseFloat(t)),t<i}else return!1}getTooltipData(e){return this.userPermissions().show_cost?e.unit_cost:null}removeRow(e){e<0||e>=this.invoice.items.length||(this.invoice.items.splice(e,1),this.recalculateTotals())}addQtyToLastItem(e=1){let i=this.invoice.items;if(i.length===0)return;let t=i[i.length-1];t.quantity=(t.quantity||0)+e,this.recalculateTotals()}removeQtyFromLastItem(e=1){let i=this.invoice.items;if(i.length===0)return;let t=i.length-1,n=i[t];(n.quantity||0)>1?(n.quantity-=e,n.quantity<1&&(n.quantity=1)):i.splice(t,1),this.recalculateTotals()}onCreateProduct(e){this.addProductToInvoice(e),this.stockService.onCreateProduct(e)}resetData(){this.invoice.customer_id=null,this.customer_balance.set({id:0,balance:0})}get selectedCustomer(){return this.customers().find(e=>e.account_id===this.invoice.customer_id)}onCustomerChange(e){this.invoice.customer_id=e?.account_id,this.loadCustomerInfo(e?.account_id),e&&(this.invoice.modify_cash=!1)}openCustomerDialog(){this.customerDialogVisible=!0}newCustomerCreated(e){this.customers.set([...this.customers(),e]),e&&this.onCustomerChange(e)}loadCustomerInfo(e){e?this.customersService.getAccountTotalBalance(e,this.defaultCurrency()):this.resetData()}onOperationTypeChange(){this.resetData(),this.invoice.customer_id&&this.loadCustomerInfo(this.invoice.customer_id)}ngOnChanges(e){e.invoice&&this.loadCustomerInfo(this.invoice.customer_id)}select(e){e.select()}calculateNewBalance(e=0,i,t=0){return e=parseFloat(e),t||(t=0),this.decimalService.add(this.decimalService.subtract(e,i),t)}openEdit(e,i,t,n){this.editingRowIndex=t,this.editingField=n;let s=this.invoice.items[t];switch(n){case"quantity":this.editingValue=s.quantity;break;case"price":this.editingValue=s.unit_price;break;case"total":this.editingValue=s.unit_price*s.quantity;break}e.show(i)}applyEdit(e){if(this.editingRowIndex===null)return;let i=this.invoice.items[this.editingRowIndex];this.editingField==="quantity"?i.quantity=this.editingValue:this.editingField==="price"?(i.unit_price=this.editingValue,i.unit_price_lbp=this.dollarPipe.calculate(this.editingValue)):this.editingField==="total"&&(i.unit_price=this.editingValue/i.quantity,i.unit_price_lbp=this.dollarPipe.calculate(i.unit_price)),this.editingRowIndex=null,this.editingField="",e.hide(),this.recalculateTotals()}submitEdit(e,i){e.key=="Enter"&&this.applyEdit(i)}checkout(){this.confirmShowed=!0,this.confirmationService.confirm({key:"sell",message:this.translate.instant("Are you sure that you want to submit invoice ?"),header:this.translate.instant("Warning"),acceptLabel:this.translate.instant("Yes"),rejectLabel:this.translate.instant("No"),icon:"pi pi-exclamation-triangle",acceptButtonStyleClass:"p-button-success",rejectButtonStyleClass:"p-button-secondary",defaultFocus:"reject"})}confirmCheckout(e=!1){this.confirmShowed=!1,this.checkoutLoading=!0;let i=this.invoice;i.exchange_rate=this.stockService.exchangeRate().rate_value,i.currency=this.defaultCurrency(),console.log(this.defaultInventory()),i.inventory_id=this.defaultInventory(),this.apiService.post("return",i).pipe(ae(()=>{this.checkoutLoading=!1,this.confirmationService.close()})).subscribe({next:t=>{if(this.resetData(),this.notificationService.showSuccess("Invoice submitted","home"),this.returnService.closeInvoice(this.invoice.id),this.stockService.getProducts(),this.historyService.fetchSalesHistory(),this.cashBalanceService.getBalance(),e&&(this.dataToPrint=t,this.printDialogVisible=!0),this.thermalPrinterEnabled()){let n=structuredClone(t),s=0;n.items.forEach(_=>{s=this.decimalService.add(s,this.decimalService.multiply(this.dollarPipe.calculate(_.unit_price),_.quantity))}),n.total_lbp=s,this.printerSettings().auto_print&&this.printService.thermalPrint(n,"return"),localStorage.setItem("PrintInvoice",JSON.stringify(n))}}})}rejectCheckout(){this.confirmationService.close(),this.confirmShowed=!1,this.checkoutLoading=!1}confirmCheckoutAndPrint(){this.confirmCheckout(!0)}clearInvoice(){this.confirmShowed=!0,this.confirmationService.confirm({key:"clearInvoice",message:this.translate.instant("Are you sure you want to clear invoice?"),header:this.translate.instant("Warning"),acceptLabel:this.translate.instant("Yes"),rejectLabel:this.translate.instant("No"),icon:"pi pi-exclamation-triangle",acceptButtonStyleClass:"p-button-danger",rejectButtonStyleClass:"p-button-secondary",defaultFocus:"reject",accept:()=>{this.returnService.closeInvoice(this.invoice.id),this.checkoutLoading=!1,this.confirmShowed=!1},reject:()=>{this.confirmShowed=!1}})}openPrintDialog(){this.dataToPrint=structuredClone(this.invoice),this.dataToPrint.type="quote",this.dataToPrint.order_datetime=new Date,this.dataToPrint.exchange_rate=this.stockService.exchangeRate().rate_value,this.printDialogVisible=!0}getProducts(){this.stockService.getProducts(this.defaultInventory())}static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275cmp=M({type:o,selectors:[["return-table"]],viewQuery:function(i,t){if(i&1&&(B(nt,5),B(ot,5,te),B(rt,5,te)),i&2){let n;k(n=R())&&(t.productAutoComplete=n.first),k(n=R())&&(t.barcodeInput=n.first),k(n=R())&&(t.confirmDialog=n.first)}},hostBindings:function(i,t){i&1&&v("keydown",function(s){return t.onKeyDown(s)},!1,ce)},inputs:{invoice:"invoice"},standalone:!0,features:[se,E],decls:36,vars:35,consts:[["invoiceTable",""],["op",""],["confirmDialog",""],["productAutoComplete","","barcodeInput",""],["styleClass","mb-2"],["class","grid",4,"ngIf"],["dataKey","product_id","styleClass","p-datatable-sm ","editMode","cell",3,"value"],["pTemplate","caption"],["pTemplate","header"],["pTemplate","body"],["pTemplate","summary"],["pTemplate","emptymessage"],[1,"grid","mt-3"],[1,"col-2"],["icon","pi pi-times","severity","danger","size","small","styleClass","w-full",3,"onClick","label"],["icon","pi pi-cart-plus","severity","success","size","small","styleClass","w-full",3,"onClick","label","loading","disabled"],[3,"visibleChange","onCreate","visible","mode"],[3,"onHide","onSubmit","visible","products","tableLoading"],["appendTo","body",3,"onShow","onHide","dismissable"],[1,"formgrid","grid"],[1,"field","col-12"],["class","p-inputtext-sm","styleClass","input-align-center","step","0",3,"ngModel","maxFractionDigits","min","autofocus","ngModelChange","onFocus","onBlur","onKeyDown",4,"ngIf"],["class","p-inputtext-sm","min","0.1","step","0.1",3,"ngModel","maxFractionDigits","minFractionDigits","autofocus","ngModelChange","onFocus","onBlur","onKeyDown",4,"ngIf"],["mode","add",3,"visibleChange","onCreate","visible"],[3,"visibleChange","visible","invoice"],["key","sell",3,"breakpoints"],["pTemplate","footer"],["key","clearInvoice",3,"breakpoints"],[1,"grid"],[1,"flex","flex-column","gap-1"],["for","customer"],["styleClass","p-inputtext-sm","appendTo","body",3,"onShow","onHide","onChange","loading","placeholder","emptyMessage","filter","showClear","autoOptionFocus","filterFields","options","ngModel"],["pTemplate","item"],["pTemplate","selectedItem"],["class","col-4",4,"ngIf"],[4,"ngIf"],[1,"col-4"],[1,"text-green-500"],[1,"text-center"],["loaderClass","flex-grow-1 flex-shrink-1",2,"width","50%",3,"isLoading","loadingBar"],["loaderClass","flex-grow-1 flex-shrink-1",2,"width","63%",3,"isLoading","loadingBar"],[1,"col-3"],["dataKey","product_id","field","product_name","spellcheck","false","styleClass","p-inputtext-sm",3,"completeMethod","ngModelChange","onKeyUp","suggestions","dropdown","minLength","showClear","ngModel","placeholder","emptyMessage","delay"],["severity","warning","size","small","icon","pi pi-list","styleClass","mx-2",3,"onClick","label"],["id","inventory_id","styleClass","p-inputtext-sm","scrollHeight","400px","appendTo","body","optionLabel","inventory_name","optionValue","inventory_id","filterBy","inventory_name",3,"ngModelChange","autoOptionFocus","ngModel","options","placeholder","emptyMessage","filter"],[1,"col-3","flex","align-items-center","gap-2"],["for","modifyCash"],["id","modifyCash",3,"ngModelChange","ngModel","disabled"],["width","10%"],["width","15%"],["width","35%"],["width","5%"],["width","10%","tooltipPosition","top",3,"pTooltip"],["tooltipPosition","top",1,"pointer",3,"pTooltip"],[1,"editable",3,"click"],[1,"danger-hover",3,"click"],[1,"pi","pi-trash"],["class","text-center m-0",4,"ngIf"],[1,"text-center","m-0"],[1,"surface-300"],["colspan","9"],["styleClass","input-align-center","step","0",1,"p-inputtext-sm",3,"ngModelChange","onFocus","onBlur","onKeyDown","ngModel","maxFractionDigits","min","autofocus"],["min","0.1","step","0.1",1,"p-inputtext-sm",3,"ngModelChange","onFocus","onBlur","onKeyDown","ngModel","maxFractionDigits","minFractionDigits","autofocus"],["icon","pi pi-print","severity","contrast","size","small",1,"mr-6",3,"onClick","label"],["icon","pi pi-times","styleClass","mr-2 p-confirm-dialog-reject","severity","danger","size","small",3,"onClick","label"],["styleClass","p-confirm-dialog-accept","icon","pi pi-check","severity","success","size","small",3,"onClick","label"]],template:function(i,t){if(i&1){let n=V();a(0,"p-card",4),x(1,dt,12,18,"div",5),P(2,"br"),a(3,"p-table",6,0),x(5,_t,19,30,"ng-template",7)(6,ht,26,27,"ng-template",8)(7,ft,21,16,"ng-template",9)(8,vt,1,1,"ng-template",10)(9,Ct,4,3,"ng-template",11),l(),a(10,"div",12)(11,"div",13)(12,"p-button",14),c(13,"translate"),v("onClick",function(){return d(n),m(t.clearInvoice())}),l()(),a(14,"div",13)(15,"p-button",15),c(16,"translate"),v("onClick",function(){return d(n),m(t.checkout())}),l()()()(),a(17,"customer-dialog",16),I("visibleChange",function(_){return d(n),T(t.customerDialogVisible,_)||(t.customerDialogVisible=_),m(_)}),v("onCreate",function(_){return d(n),m(t.newCustomerCreated(_))}),l(),a(18,"products-dialog",17),v("onHide",function(){return d(n),m(t.productsDialogVisible=!1)})("onSubmit",function(_){return d(n),m(t.assignSelectedProducts(_))}),l(),a(19,"p-overlayPanel",18,1),v("onShow",function(){return d(n),m(t.editModeEnabled=!0)})("onHide",function(){return d(n),m(t.editModeEnabled=!1)}),a(21,"div",19)(22,"div",20)(23,"label"),f(24),c(25,"translate"),l(),x(26,yt,1,4,"p-inputNumber",21)(27,bt,1,4,"p-inputNumber",21)(28,xt,1,4,"p-inputNumber",22),l()()(),a(29,"product-form",23),I("visibleChange",function(_){return d(n),T(t.productDialogVisible,_)||(t.productDialogVisible=_),m(_)}),v("onCreate",function(_){return d(n),m(t.onCreateProduct(_))}),l(),a(30,"print-dialog",24),I("visibleChange",function(_){return d(n),T(t.printDialogVisible,_)||(t.printDialogVisible=_),m(_)}),l(),a(31,"p-confirmDialog",25,2),x(33,St,6,9,"ng-template",26),l(),P(34,"p-confirmDialog",27,2)}i&2&&(r(),h("ngIf",t.customersFeaturesEnabled()),r(2),h("value",t.invoice.items),r(9),h("label",p(13,25,"Clear")),r(3),h("label",p(16,27,"Checkout"))("loading",t.checkoutLoading)("disabled",t.invoice.items.length==0),r(2),w("visible",t.customerDialogVisible),h("mode","add"),r(),h("visible",t.productsDialogVisible)("products",t.products)("tableLoading",t.stockTableLoading()),r(),h("dismissable",!0),r(5),b("",p(25,29,t.editingField),": "),r(2),h("ngIf",t.editingField==="price"),r(),h("ngIf",t.editingField==="total"),r(),h("ngIf",t.editingField==="quantity"),r(),w("visible",t.productDialogVisible),r(),w("visible",t.printDialogVisible),h("invoice",t.dataToPrint),r(),ie(D(31,Xe)),h("breakpoints",D(32,$e)),r(3),ie(D(33,Xe)),h("breakpoints",D(34,$e)))},dependencies:[A,O,W,Q,K,me,Ve,Ie,z,ge,he,fe,xe,Ce,ve,Me,Pe,ye,Ue,Re,ke,Te,we,G,Ae,We,Ze,je,Ke,He,Be,ze,Qe,Ye,Je,Ne,Fe,Y],styles:["[_nghost-%COMP%]  .p-card-body{padding:.8rem!important;padding-top:.3!important}[_nghost-%COMP%]  .p-card-content{padding:0!important}[_nghost-%COMP%]  .p-datatable{font-size:.9rem!important}[_nghost-%COMP%]  .p-datatable-header{padding-bottom:0!important}table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:.9rem;text-align:center}table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:.5rem;border:none}table[_ngcontent-%COMP%]   thead[_ngcontent-%COMP%]{border-top:1px solid #dee2e6;border-bottom:1px solid #dee2e6}table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]   tr[_ngcontent-%COMP%]{border-top:1px solid #dee2e6}table[_ngcontent-%COMP%]   tbody[_ngcontent-%COMP%]{border-bottom:1px solid #dee2e6}.editable-cell[_ngcontent-%COMP%]{cursor:pointer;background-color:#f8f9fa}.editable[_ngcontent-%COMP%]{cursor:pointer;background-color:#e6e6e6}.editable[_ngcontent-%COMP%]:hover{background-color:#bebebe}[_nghost-%COMP%]  .p-button{padding:.6rem 1.09375rem!important}[_nghost-%COMP%]  .p-button.p-button-sm{font-size:.875rem!important;padding:.65625rem 1.09375rem!important}"]})}}return o})();var et=(()=>{class o{constructor(){this.currencyService=g(F),this.defaultCurrency=this.currencyService.defaultCurrency}static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275cmp=M({type:o,selectors:[["return-total"]],inputs:{invoice:"invoice"},standalone:!0,features:[E],decls:13,vars:13,consts:[["styleClass","mb-1"],[1,"flex","justify-content-between"],[1,"text-green-600","m-2"],[1,"text-bluegray-900","m-2"],[1,"text-primary","m-2"]],template:function(i,t){i&1&&(a(0,"p-card",0)(1,"div",1)(2,"h2",2),f(3),c(4,"currency"),c(5,"exchangedLira"),l(),a(6,"h2",3),f(7),c(8,"translate"),l(),a(9,"h2",4),f(10),c(11,"lira"),c(12,"lira"),l()()()),i&2&&(r(3),b(" USD: ",t.defaultCurrency()==="dollar"?p(4,3,t.invoice.total_amount):p(5,5,t.invoice.total_amount)," "),r(4),b(" ",p(8,7,"Return Invoice")," "),r(3),b(" ",t.defaultCurrency()==="dollar"?p(11,9,t.invoice.total_lbp):p(12,11,t.invoice.total_amount)," "))},dependencies:[G,Y,W,Q,K,z,Ge],styles:["[_nghost-%COMP%]  .p-card-body{padding:.8rem!important}[_nghost-%COMP%]  .p-card-content{padding:0!important}"]})}}return o})();function wt(o,C){if(o&1&&P(0,"return-table",2),o&2){let e=u();h("invoice",e.returnService.activeInvoice)}}var nn=(()=>{class o{constructor(){this.returnService=g($)}static{this.\u0275fac=function(i){return new(i||o)}}static{this.\u0275cmp=M({type:o,selectors:[["app-return-home"]],viewQuery:function(i,t){if(i&1&&B(oe,5),i&2){let n;k(n=R())&&(t.returnTableComponent=n.first)}},standalone:!0,features:[E],decls:4,vars:2,consts:[[1,"grid","m-1"],[1,"col-12"],[3,"invoice"],[3,"invoice",4,"ngIf"]],template:function(i,t){i&1&&(a(0,"div",0)(1,"div",1),P(2,"return-total",2),x(3,wt,1,1,"return-table",3),l()()),i&2&&(r(2),h("invoice",t.returnService.activeInvoice),r(),h("ngIf",t.returnService.activeInvoice))},dependencies:[A,O,oe,et]})}}return o})();export{nn as ReturnHomeComponent};
